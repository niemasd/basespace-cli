
from cliff.complete import CompleteDictionary,CompleteCommand


class Dictionary(CompleteDictionary):
    """dictionary for bash completion"""

    def get_commands(self):
        return '\\n'.join(k for k in sorted(self._dictionary.keys()))

    def add_command(self, command, actions):
        optstr = '\\n'.join(opt for action in actions
                          for opt in action.option_strings)
        dicto = self._dictionary
        for subcmd in command[:-1]:
            dicto = dicto.setdefault(subcmd, {})
        dicto[command[-1]] = optstr


class Complete(CompleteCommand):
    """print bash completion command"""

    def __init__(self, app, app_args, output=None):
        super(Complete, self).__init__(app, app_args)
        self._output = output or self.app.stdout

    def take_action(self, parsed_args):
        name = parsed_args.name or self.app.NAME
        try:
            shell_factory = self._formatters[parsed_args.shell].plugin
        except KeyError:
            raise RuntimeError('Unknown shell syntax %r' % parsed_args.shell)
        shell = shell_factory(name, self._output)
        dicto = Dictionary()
        for cmd in self.app.command_manager:
            command = cmd[0].split()
            dicto.add_command(command, self.get_actions(command))

        shell.write(dicto.get_commands(), dicto.get_data())
        return 0

