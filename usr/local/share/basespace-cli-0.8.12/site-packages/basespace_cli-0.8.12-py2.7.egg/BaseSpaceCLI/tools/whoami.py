from ..common.interface import InternalListerCommand
from .. import __log_terse_level__

class WhoAmI(InternalListerCommand):
    "get information about selected config"

    __category__ = "Credentials"

    def __init__(self, app, app_args, cmd_name=None):
        super(WhoAmI, self).__init__(app, app_args, self.__class__.__name__)
        return

    def get_parser(self, prog_name):
        parser = super(WhoAmI, self).get_parser(prog_name)
        return parser

    def take_action(self, parsed_args):
        token_details = self.api.getAccessTokenDetails()
        user_details = token_details.UserResourceOwner
        # workaround Cliff bug
        # Error: need to escape, but no escapechar set
        if parsed_args.quote_mode == "none":
            parsed_args.quote_mode = "minimal"
        if self.app.options.terse:
            # same hack as we used in listEntities
            self.formatter = self._formatter_plugins["value"].obj
            return ("Id",), ((user_details.Id,),)
        else:
            headers = ("key", "value")
            keys = [
                "Name",
                "Id",
                "Email",
                "ApplicationName",
                "DateCreated",
                "Scopes"
            ]
            values = [
                user_details.Name,
                user_details.Id,
                user_details.Email,
                token_details.Application.Name,
                str(token_details.DateCreated),
                ",".join(token_details.Scopes)
            ]
        return headers, zip(keys, values)